# Makefile for Signal Matching Backend
# Usage: make <command>

.PHONY: help setup install run seed seed-presentation test-db clean docker-up docker-down reset docker-build docker-run docker-logs docker-seed-presentation

# Default target
help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘           ğŸš€ Signal Matching Backend - Makefile                  â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Setup & Installation:                                          â•‘"
	@echo "â•‘    make setup      - Create venv and install dependencies       â•‘"
	@echo "â•‘    make install    - Install dependencies only                  â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Database:                                                       â•‘"
	@echo "â•‘    make docker-up  - Start PostgreSQL in Docker                 â•‘"
	@echo "â•‘    make docker-down- Stop PostgreSQL Docker                     â•‘"
	@echo "â•‘    make test-db    - Test database connection                   â•‘"
	@echo "â•‘    make seed       - Seed database with test data               â•‘"
	@echo "â•‘    make seed-presentation - Seed database with demo data        â•‘"
	@echo "â•‘    make reset      - Reset DB (drop all + re-seed)              â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Development:                                                    â•‘"
	@echo "â•‘    make run        - Start FastAPI server (port 8000)           â•‘"
	@echo "â•‘    make clean      - Remove __pycache__ and .pyc files          â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Docker (Full Stack):                                           â•‘"
	@echo "â•‘    make docker-build - Build backend Docker image               â•‘"
	@echo "â•‘    make docker-run   - Run full stack (backend + postgres)      â•‘"
	@echo "â•‘    make docker-stop  - Stop full stack                          â•‘"
	@echo "â•‘    make docker-logs  - View backend logs                        â•‘"
	@echo "â•‘    make docker-seed  - Seed database in Docker                  â•‘"
	@echo "â•‘    make docker-seed-presentation - Seed demo data in Docker     â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Quick Start:                                                    â•‘"
	@echo "â•‘    make quickstart - docker-up + setup + seed + run             â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Python executable paths
PYTHON = .venv/bin/python
PIP = .venv/bin/pip
UVICORN = .venv/bin/uvicorn

# ============================================================================
# SETUP & INSTALLATION
# ============================================================================

setup:
	@echo "ğŸ”§ Creating virtual environment..."
	python3 -m venv .venv
	@echo "ğŸ“¦ Installing dependencies..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@echo "âœ… Setup complete!"

install:
	@echo "ğŸ“¦ Installing dependencies..."
	$(PIP) install -r requirements.txt
	@echo "âœ… Dependencies installed!"

# ============================================================================
# DATABASE
# ============================================================================

docker-up:
	@echo "ğŸ³ Starting PostgreSQL in Docker..."
	docker-compose up -d
	@echo "â³ Waiting for PostgreSQL to be ready..."
	@sleep 3
	@echo "âœ… PostgreSQL is running!"

docker-down:
	@echo "ğŸ³ Stopping PostgreSQL Docker..."
	docker-compose down
	@echo "âœ… PostgreSQL stopped!"

test-db:
	@echo "ğŸ” Testing database connection..."
	PYTHONPATH=$(PWD) $(PYTHON) scripts/test_db.py

seed:
	@echo "ğŸŒ± Seeding database with test data..."
	PYTHONPATH=$(PWD) $(PYTHON) scripts/seed_test_data.py

seed-presentation:
	@echo "ğŸŒ± Seeding database with presentation data..."
	PYTHONPATH=$(PWD) $(PYTHON) scripts/seed_presentation_data.py

reset:
	@echo "ğŸ—‘ï¸  Resetting database..."
	@echo "âš ï¸  This will drop all tables and re-create them!"
	PYTHONPATH=$(PWD) $(PYTHON) -c "\
from services.db import engine; \
from sqlmodel import SQLModel; \
SQLModel.metadata.drop_all(engine); \
print('  âœ… All tables dropped!')"
	@echo "ğŸ“¦ Re-creating tables and seeding..."
	PYTHONPATH=$(PWD) $(PYTHON) scripts/seed_test_data.py
	@echo "âœ… Database reset complete!"

# ============================================================================
# DEVELOPMENT
# ============================================================================

run:
	@echo "ğŸš€ Starting FastAPI server..."
	@echo "ğŸ“– Swagger UI: http://localhost:8000/docs"
	@echo "ğŸ“– ReDoc: http://localhost:8000/redoc"
	PYTHONPATH=$(PWD) $(UVICORN) main:app --reload --host 0.0.0.0 --port 8000

clean:
	@echo "ğŸ§¹ Cleaning up..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@echo "âœ… Cleaned!"

# ============================================================================
# QUICK START
# ============================================================================

quickstart: docker-up setup seed run
	@echo "ğŸ‰ Quick start complete!"

# ============================================================================
# DOCKER (FULL STACK)
# ============================================================================

docker-build:
	@echo "ğŸ³ Building backend Docker image..."
	docker-compose build backend
	@echo "âœ… Image built!"

docker-run:
	@echo "ğŸ³ Starting full stack (backend + postgres)..."
	docker-compose up -d
	@echo "â³ Waiting for services to start..."
	@sleep 5
	@echo "âœ… Stack is running!"
	@echo "ğŸ“– Swagger UI: http://localhost:8000/docs"
	@echo "ğŸ“– ReDoc: http://localhost:8000/redoc"

docker-stop:
	@echo "ğŸ³ Stopping full stack..."
	docker-compose down
	@echo "âœ… Stack stopped!"

docker-logs:
	@echo "ğŸ“‹ Backend logs:"
	docker-compose logs -f backend

docker-seed:
	@echo "ğŸŒ± Seeding database in Docker..."
	docker-compose exec backend python scripts/seed_test_data.py
	@echo "âœ… Database seeded!"

docker-seed-presentation:
	@echo "ğŸŒ± Seeding demo database in Docker..."
	docker-compose exec backend python scripts/seed_presentation_data.py
	@echo "âœ… Demo database seeded!"

docker-reset:
	@echo "ğŸ—‘ï¸  Resetting database in Docker..."
	docker-compose exec backend python -c "\
from services.db import engine; \
from sqlmodel import SQLModel; \
SQLModel.metadata.drop_all(engine); \
print('  âœ… All tables dropped!')"
	@echo "ğŸ“¦ Re-creating tables and seeding..."
	docker-compose exec backend python scripts/seed_test_data.py
	@echo "âœ… Database reset complete!"

docker-shell:
	@echo "ğŸš Opening shell in backend container..."
	docker-compose exec backend /bin/bash

# ============================================================================
# TESTING HELPERS (curl commands)
# ============================================================================

test-login:
	@echo "ğŸ” Testing login (jan@freelancer.pl)..."
	@curl -s -X POST http://localhost:8000/auth/login \
		-H "Content-Type: application/json" \
		-d '{"email": "jan@freelancer.pl", "password": "Test1234!"}' | python3 -m json.tool

test-register:
	@echo "ğŸ“ Testing registration..."
	@curl -s -X POST http://localhost:8000/auth/register \
		-H "Content-Type: application/json" \
		-d '{"username": "test_user", "email": "test@test.com", "password": "Test1234!"}' | python3 -m json.tool
